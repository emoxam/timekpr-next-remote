<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timekpr Next Remote</title>
    <script src="{{ url_for('static', filename='jquery-3.6.3.min.js') }}"></script>

        <style>
            body {
                font-size: 2.5vw;
            }
            button {
                font-size: 2vw;
            }

            @media screen and (max-width: 420px) {
                body {
                    font-size: 5vw;

                }
                button {
                    font-size: 3vw;
                }
            }

            /* ==========================================================================
               Fork Me on Github Stuffs
               ========================================================================== */
            #forkongithub a {
                background:#000;
                color:#ddd;
                text-decoration:none;
                font-family:arial,sans-serif;
                text-align:center;
                font-weight:bold;
                padding:5px 40px;
                transition:0.5s;
                font-size:.8rem;
                line-height: 1rem;
                width:200px;
                position:absolute;
                top:60px;
                right:-40px;
                transform:rotate(45deg);
                -webkit-transform:rotate(45deg);
                -ms-transform:rotate(45deg);
                -moz-transform:rotate(45deg);
                -o-transform:rotate(45deg);
                box-shadow:4px 4px 10px rgba(0,0,0,0.8);
            }
            #forkongithub a:hover{background:#c11;
                color:#fff;
            }
            #forkongithub a::before,#forkongithub a::after{
                content:"";
                width:100%;
                display:block;
                position:absolute;
                top:1px;
                left:0;
                height:1px;
                background:#fff;
            }
            #forkongithub a::after{
                bottom:1px;
                top:auto;
            }
            #forkongithub {
                position:fixed;
                display:block;
                width:200px;
                overflow:hidden;
                height:200px;
                z-index:9999;
                right: -55px;
                top: -30px;
            }

        </style>
</head>
<body>
    <!-- thanks https://codepo8.github.io/css-fork-on-github-ribbon/ ! -->
    <span id="forkongithub" class="hidden-print ">
        <a href="https://github.com/mrjones-plip/timekpr-next-remote">Fork me on GitHub</a>
    </span>

    <h1>Timekpr Next Remote</h1>
    <div id="people"></div>

<script>
$.getJSON( "/config", function( data ) {
    let last_computer = ''
    const items = [];
    $.each( data, function( computer, user ) {
        if (last_computer !== computer){
            items.push("<h2>" + computer + ":</h2>");
            last_computer = computer;
        }
        const seconds_left = get_usage(user, computer);
        items.push(
            "<span class='user' id='"+ user + "'>" +
                "<b>" + user + "</b> " +
                "<span id='usage'>" + secondsToHms(seconds_left) + " remain</span><br/>" +
                "<input type='radio'  id='add' value='add' name='action'><label for='add'>Add</label>" +
                "<input type='radio'  id='remove' value='remove' name='action'><label for='remove'>Remove</label> " +
                "<button value='300' user='"+ user + "' computer='" + computer + "'>5 min</button> " +
                "<button value='900' user='"+ user + "' computer='" + computer + "'>15 min</button> " +
                "<button value='1800' user='"+ user + "' computer='" + computer + "'>30 min</button> " +
                "<button value='2700' user='"+ user + "' computer='" + computer + "'>45 min</button> " +
                "<button value='3600'  user='"+ user + "' computer='" + computer + "'>1 hr</button> " +
            "</span>"
        );
        get_usage();
    });

    $("#people").html(items.join( "" ));

    $("button" ).click(function() {
        const user = $( this ).attr('user');
        const computer = $( this ).attr('computer');
        const action = $( '#' + user + ' input[name="action"]:checked').val();
        const seconds = $( this ).val();
        if(action !== undefined){
            add_or_remove_time(user, computer, action, seconds);
        } else {
            alert("Choose 'Add' or 'Remove'");
        }
    });
});

function add_or_remove_time(user, computer, action, seconds){
    let form;
    if(action === 'add'){
        form = 'increase_time'
    } else {
        form = 'decrease_time'
    }
    $.getJSON("/" + form + "/" + computer + "/" + user + "/" + seconds, function( data ) {
        $('#' + user + " #usage").html(secondsToHms(data.usage));
    });
}

function get_usage(user, computer){
    return $.ajax({
        type: "GET",
        url: "/get_usage/" + computer + "/" + user,
        async: false
    }).responseText;
}

// thanks https://stackoverflow.com/a/37096512 !
function secondsToHms(d) {
    d = Number(d);
    var h = Math.floor(d / 3600);
    var m = Math.floor(d % 3600 / 60);
    var s = Math.floor(d % 3600 % 60);

    var hDisplay = h > 0 ? h + (h === 1 ? " hr " : " hrs ") : "";
    var mDisplay = m > 0 ? m + (m === 1 ? " min " : " mins ") : "";
    var sDisplay = s > 0 ? s + (s === 1 ? " sec" : " secs") : "";
    return hDisplay + mDisplay + sDisplay;
}

</script>
</body>
</html>
