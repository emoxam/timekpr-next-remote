<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static', filename='bootstrap.5.1.3.min.css') }}" rel="stylesheet" >
        <style>
            .time {
                font-style: italic;
            }
            .notify {
                display: none;
                color: blue;
                margin-left: 4px;
            }

            /* ==========================================================================
               Fork Me on Github Stuffs
               ========================================================================== */
            #forkongithub a {
                background:#000;
                color:#ddd;
                text-decoration:none;
                font-family:arial,sans-serif;
                text-align:center;
                font-weight:bold;
                padding:5px 40px;
                transition:0.5s;
                font-size:.8rem;
                line-height: 1rem;
                width:200px;
                position:absolute;
                right: 17px;
                top: 77px;
                transform:rotate(45deg);
                -webkit-transform:rotate(45deg);
                -ms-transform:rotate(45deg);
                -moz-transform:rotate(45deg);
                -o-transform:rotate(45deg);
                box-shadow:4px 4px 10px rgba(0,0,0,0.8);
            }
            #forkongithub a:hover{background:#c11;
                color:#fff;
            }
            #forkongithub a::before,#forkongithub a::after{
                content:"";
                width:100%;
                display:block;
                position:absolute;
                top:1px;
                left:0;
                height:1px;
                background:#fff;
            }
            #forkongithub a::after{
                bottom:1px;
                top:auto;
            }
            #forkongithub {
                position:fixed;
                display:block;
                width:200px;
                overflow:hidden;
                height:200px;
                z-index:9999;
                right: -55px;
                top: -30px;
            }
            @media only screen and (max-width: 600px) {
                #forkongithub {
                    width: 173px;
                    height: 150px;
                }
                #forkongithub a {
                    font-size: 0.6rem;
                    line-height: .3rem;
                    right: -13px;
                    top: 57px;
                }
                .btn-group {
                    width: 100%;
                    padding: 5px 0 0 0;
                }
            }

        </style>
    <title>Timekpr Next Remote</title>
  </head>
  <body>
    <!-- thanks https://codepo8.github.io/css-fork-on-github-ribbon/ ! -->
    <span id="forkongithub" class="hidden-print ">
        <a href="https://github.com/mrjones-plip/timekpr-next-remote">Fork me on GitHub</a>
    </span>
<div class="container-sm">

  <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
    <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
    <span class="fs-1">Timekpr Next Remote</span>
    </a>
  </header>

  <div class="b-example-divider"></div>
    <div id="people"></div>
</div>
    <script src="{{ url_for('static', filename='bootstrap.5.1.3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='jquery-3.6.3.min.js') }}"></script>
    <script>
    $.getJSON( "/config", function( data ) {
        const items = [];
        const second_options = [300, 900, 1800, 2700, 3600];
        $.each( data, function( computer, user ) {
            let usage = $.parseJSON(get_usage(user, computer));
            items.push(
                "<span class='user' id='"+ user + "'>" +
                    "<p  class='h3'>" + user  + "<span class='notify'>Updated!</span><p>" +
                    "<span>Unused: <span class='time' id='time_left'>" + secondsToHms(usage.time_left) + "</span> </span>" +
                    "<span>Used: <span class='time'  id='time_spent'>" + secondsToHms(usage.time_spent) + "</span></span><br/>" +
                    "<div class='btn-group' role='group' aria-label='Action'>" +
                        "<input type='radio'  class='btn-check' id='add' value='add' name='action' />" +
                        "<label  class='btn btn-outline-primary' for='add'>Add</label>" +
                        "<input type='radio'  class='btn-check' id='remove' value='remove' name='action' />" +
                        "<label  class='btn btn-outline-primary' for='remove'>Remove</label> " +
                    "</div> " +
                    "<div class='btn-group' role='group' aria-label='Times'>"
                );
            $.each(second_options, function(index, seconds) {
                items.push(
                    "<input type='radio'  class='btn-check'  value='" + seconds + "' id='the" + seconds + "' name='seconds' />" +
                    "<label  class='btn btn-outline-primary' for='the" + seconds + "'>" + secondsToHms(seconds) + "</label>");
            });
            items.push(
                    "</div>" +
                    "<div class='btn-group' role='group' aria-label='save'>" +
                        "<button class='btn btn-outline-primary' " +
                            "id='save_me' value='save' user='" + user + "' computer='" + computer + "' >Save</button>" +
                    "</div> " +
                "</span>"
                );
            get_usage();
        });

        $("#people").html(items.join( "" ));

        $("#save_me" ).click(function() {
            const user = $( this ).attr('user');
            const computer = $( this ).attr('computer');
            const action = $( '#' + user + ' input[name="action"]:checked').val();
            const seconds = $( '#' + user + ' input[name="seconds"]:checked').val();
            if(action !== undefined && seconds !== undefined){
                $('input').prop('checked', false);
                add_or_remove_time(user, computer, action, seconds);
                $( '#' + user + ' .notify').fadeIn(function() {
                    setTimeout(function() {
                        $('#' + user + ' .notify').fadeOut("slow");
                    }, 1000);
                });
            } else {
                alert("Choose 'Add' or 'Remove' and choose an amount of time to add.");
            }
        });
    });

    function add_or_remove_time(user, computer, action, seconds){
        let form;
        if(action === 'add'){
            form = 'increase_time'
        } else {
            form = 'decrease_time'
        }
        console.log("add_or_remove_time callded: form", form,"computer", computer,"user",user,"seconds",seconds);
        $.getJSON("/" + form + "/" + computer + "/" + user + "/" + seconds, function( data ) {
            $('#' + user + " #time_left").html(secondsToHms(data.time_left));
            $('#' + user + " #time_spent").html(secondsToHms(data.time_spent));
        });
    }

    function get_usage(user, computer){
        return $.ajax({
            type: "GET",
            url: "/get_usage/" + computer + "/" + user,
            async: false
        }).responseText;
    }

    // thanks https://stackoverflow.com/a/37096512 !
    function secondsToHms(d) {
        if (Number(d) === 0){
            return "none";
        }
        d = Number(d);
        var h = Math.floor(d / 3600);
        var m = Math.floor(d % 3600 / 60);
        var s = Math.floor(d % 3600 % 60);

        var hDisplay = h > 0 ? h + (h === 1 ? " hr " : " hrs ") : "";
        var mDisplay = m > 0 ? m + (m === 1 ? " min " : " mins ") : "";
        var sDisplay = s > 0 ? s + (s === 1 ? " sec" : " secs") : "";
        return hDisplay + mDisplay + sDisplay;
    }

    </script>
  </body>
</html>




